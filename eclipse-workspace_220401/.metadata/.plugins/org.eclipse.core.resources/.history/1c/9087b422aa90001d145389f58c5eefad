/*
 * SocketHandler.cpp
 *
 *  Created on: 2021. 12. 6.
 *      Author: hong
 */

#include "SocketHandler.h"

Socket* pSocket;
MsgQueue* pUartQueue;
int nServiceStart_Confirm =0;
int nTagDataCount =0;
std::vector<std::vector<BYTE>> vTagData;

SocketHandler::SocketHandler()
{
}

SocketHandler::~SocketHandler() {
	// TODO Auto-generated destructor stub
}

int SocketHandler::SendMessage(int msg, PRE_DEFINE::S_PACKET packet)
{
	int msgtype =0;
	//uint8_t pu8data[15] = {0xaa, 0, 0xfc, 0x01, 0, 0x01, 0, 0x05, 0x01, 0, 0, 0x04, 0xa5, 0x5a, 0x7e};
	//printf("SocketHandler SendMessage\n");
	msgtype = msg;

	switch(msgtype)
	{
	case REGISTRATION_REQUEST:
		printf("Socket SendMsg : REGISTRATION_REQUEST\n");
		Registration_Request();
		break;
	case CONNECT_REQUEST:
		printf("Socket SendMsg : CONNECT_REQUEST\n");
		Connect_Request();
		break;
	case DOWNLOAD_START_ACK:
		printf("Socket SendMsg : DOWNLOAD_START_ACK\n");
		break;
	case TAG_ASSOCIATION:
		printf("Socket SendMsg : TAG_ASSOCIATION\n");
		break;
	default :
		printf("Socket SendMsg : default msgtype :0x%x\n", packet.header.type);
		SendSocket_Data(packet);
		break;
	}

	return 1;
}


int SocketHandler::SendSocket_Data(PRE_DEFINE::S_PACKET packet)
{
	BYTE pu8data[1024] = {0, };
	BYTE u8Checksum;
	int iBufcnt =0;

	pu8data[iBufcnt] = packet.header.stx;
	printf("ByPass() %x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.panID << 8;//packet.PanID << 8;
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.panID >> 8;
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.dAddr; //ServerID;
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.dAddr >> 8;
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = (BYTE)packet.header.sAddr;//0x01;		//gateway ID
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.sAddr >> 8;//0xfb;		//gateway ID
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.type; //SERVICESTART_CONFIRM;	//msg type
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.length;//0x01;	//Data Length
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.header.length >> 8;
	printf("%x ", pu8data[iBufcnt]);
	for(int i=0; i< (int)packet.header.length; i++) {
		if(nServiceStart_Confirm) {
			pu8data[++iBufcnt] = 0x06;
		}
		else {
			pu8data[++iBufcnt] = packet.pu8Data[i];//0x01;
		}
		printf("%x ", pu8data[iBufcnt]);
	}

	u8Checksum = GetChecksum(pu8data, iBufcnt);
	pu8data[++iBufcnt] = u8Checksum; //0x07;
	printf("%x ", pu8data[iBufcnt]);

	pu8data[++iBufcnt] = packet.tail.ext[0];
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.tail.ext[1];
	printf("%x ", pu8data[iBufcnt]);
	pu8data[++iBufcnt] = packet.tail.ext[2];
	printf("%x\n", pu8data[iBufcnt]);

	packet.header.DataLength = iBufcnt+1;
	pSocket->Send_Message(pu8data, packet.header.DataLength);

	return 1;
}

int SocketHandler::DownLoad_Start_Ack()
{
	BYTE pu8data[30];
	BYTE u8Checksum;
	int iBufcnt =0;

	pu8data[iBufcnt] = STX;
	pu8data[++iBufcnt] = (BYTE)packet.PanID;
	pu8data[++iBufcnt] = packet.PanID >> 8;
	pu8data[++iBufcnt] = packet.ServerID;
	pu8data[++iBufcnt] = packet.ServerID >> 8;
	pu8data[++iBufcnt] = (BYTE)packet.GateWayID;		//gateway ID
	pu8data[++iBufcnt] = packet.GateWayID >> 8;		//gateway ID
	pu8data[++iBufcnt] = DOWNLOAD_START_ACK;	//msg type
	pu8data[++iBufcnt] = 0x0a;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0x01;

	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;

	u8Checksum = GetChecksum(pu8data, iBufcnt);
	pu8data[++iBufcnt] = u8Checksum; //0x07;

	pu8data[++iBufcnt] = packet.ext[0];
	pu8data[++iBufcnt] = packet.ext[1];
	pu8data[++iBufcnt] = packet.ext[2];

	pSocket->Send_Message(pu8data, iBufcnt);

	return 1;
}


int SocketHandler::Connect_Request()
{
	BYTE pu8data[30];
	BYTE u8Checksum;
	int iBufcnt =0;

	pu8data[iBufcnt] = STX;
	pu8data[++iBufcnt] = (BYTE)packet.PanID;
	pu8data[++iBufcnt] = packet.PanID >> 8;
	pu8data[++iBufcnt] = packet.ServerID;
	pu8data[++iBufcnt] = packet.ServerID >> 8;
	pu8data[++iBufcnt] = (BYTE)packet.GateWayID;		//gateway ID
	pu8data[++iBufcnt] = packet.GateWayID >> 8;		//gateway ID
	pu8data[++iBufcnt] = CONNECT_REQUEST;	//msg type
	pu8data[++iBufcnt] = 0x0a;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0x01;

	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;
	pu8data[++iBufcnt] = 0;

	u8Checksum = GetChecksum(pu8data, iBufcnt);
	pu8data[++iBufcnt] = u8Checksum; //0x07;

	pu8data[++iBufcnt] = packet.ext[0];
	pu8data[++iBufcnt] = packet.ext[1];
	pu8data[++iBufcnt] = packet.ext[2];

	pSocket->Send_Message(pu8data, iBufcnt+1);
	pSocket->m_pSocMsgqueue->GetServerID(packet.ServerID);

	return 1;
}

int SocketHandler::Registration_Request()
{
	uint8_t pu8data[25];
	BYTE u8Checksum;
	int iBufcnt =0;

	packet.GateWayID = packet.PanID;

	printf("packet.GateWayID  : %x\n", packet.GateWayID);
	printf("packet.GateWayID : %x\n", (BYTE)packet.GateWayID);

	pu8data[iBufcnt] = STX;
	pu8data[++iBufcnt] = (BYTE)packet.PanID;
	pu8data[++iBufcnt] = packet.PanID >> 8;
	pu8data[++iBufcnt] = 0xff;
	pu8data[++iBufcnt] = 0xff;
	pu8data[++iBufcnt] = (BYTE)packet.GateWayID;
	pu8data[++iBufcnt] = (packet.GateWayID >> 8);
	pu8data[++iBufcnt] = REGISTRATION_REQUEST;	//msg type
	pu8data[++iBufcnt] = 0x07;						//Data Length
	pu8data[++iBufcnt] = 0;						//Data Length
	pu8data[++iBufcnt] = 0;						//regType
	pu8data[++iBufcnt] = 0;						//Mac addr
	pu8data[++iBufcnt] = 1;		//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	u8Checksum = GetChecksum(pu8data, iBufcnt);	//check sum
	pu8data[++iBufcnt] = u8Checksum; //0x07;
	pu8data[++iBufcnt] = packet.ext[0];
	pu8data[++iBufcnt] = packet.ext[1];
	pu8data[++iBufcnt] = packet.ext[2];

	pSocket->Send_Message(pu8data, iBufcnt+1);

	packet.GateWayID = packet.PanID ;
	pSocket->m_pSocMsgqueue->GetPanID(packet.PanID);
	return 1;
}

WORD SocketHandler::ByteToWord(BYTE puData, BYTE puData1)
{
	WORD p16Tempdata_HIGH, p16Tempdata_LOW;

	p16Tempdata_HIGH = (puData << 8);
	p16Tempdata_LOW = puData1;

	return p16Tempdata_HIGH|p16Tempdata_LOW;

}

void SocketHandler::GetPanID(WORD panid)
{
	packet.PanID = panid;
}

void SocketHandler::GetServerID(WORD severid)
{
	packet.ServerID = severid;

	printf("GetServerID %x\n", packet.ServerID);
}

void SocketHandler::SetMsg_StartCfm_Remalloc()
{
	if(nServiceStart_Confirm)
		nServiceStart_Confirm  =0;
	else
		nServiceStart_Confirm =1;
	printf("SetMsg_StartCfm_Remalloc()");
}

void SocketHandler::TagData(std::vector<std::vector<BYTE>> vec)
{
	BYTE pu8data[1024];
	int iBufcnt =0;

	vTagData = vec;

	printf("TagData\n");
	printf("m_nSendTagCount : %d, nTagDataCount : %d vTagData.size(); : %d, vTagData[0].size() : %d \n", pUartQueue->m_nSendTagCount, nTagDataCount, vTagData.size(), vTagData[0].size());

	for(int k=nTagDataCount; k<pUartQueue->m_nSendTagCount; k++) {
		for(int i=0; i<(int)vTagData[k].size(); i++) {
			printf("%x ", vTagData[k][i]);
			pu8data[iBufcnt] = vTagData[k][i];
			iBufcnt++;
		}
		printf("\n");
		pSocket->Send_Message(pu8data, iBufcnt+1);
		iBufcnt =0;
		memset(pu8data, 0, 1024);
		nTagDataCount++;
		printf("nTagDataCount : %d\n", nTagDataCount);
	}
	printf("TagData END()\n");
}

int SocketHandler::Tag_Association()
{
	BYTE pu8data[30];
	BYTE u8Checksum;
	int iBufcnt =0;

	pu8data[iBufcnt] = STX;
	pu8data[++iBufcnt] = (BYTE)packet.PanID;
	pu8data[++iBufcnt] = packet.PanID >> 8;
	pu8data[++iBufcnt] = 0xff;
	pu8data[++iBufcnt] = 0xff;
	pu8data[++iBufcnt] = (BYTE)packet.GateWayID;
	pu8data[++iBufcnt] = (packet.GateWayID >> 8);
	pu8data[++iBufcnt] = REGISTRATION_REQUEST;	//msg type
	pu8data[++iBufcnt] = 0x07;						//Data Length
	pu8data[++iBufcnt] = 0;						//Data Length
	pu8data[++iBufcnt] = 0;						//regType
	pu8data[++iBufcnt] = 0;						//Mac addr
	pu8data[++iBufcnt] = 1;		//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	pu8data[++iBufcnt] = 0;	//Mac addr
	u8Checksum = GetChecksum(pu8data, iBufcnt);	//check sum
	pu8data[++iBufcnt] = u8Checksum; //0x07;
	pu8data[++iBufcnt] = packet.ext[0];
	pu8data[++iBufcnt] = packet.ext[1];
	pu8data[++iBufcnt] = packet.ext[2];

	pSocket->Send_Message(pu8data, iBufcnt+1);
	return 1;
}

BYTE SocketHandler::GetChecksum(BYTE* puData, int len)
{
	BYTE sum =0;

	for(int i=1; i< len; i++) {
	//	printf("%x ", puData[i]);
		sum += puData[i];
	}
	printf("(check nsum : %x) ", sum);

	return sum;
}

void SocketHandler::SetMsgQueueHwnd(MsgQueue* soc)
{
	pUartQueue = soc;
}


void SocketHandler::SetSocketHwnd(Socket* soc)
{
	pSocket = soc;
}

